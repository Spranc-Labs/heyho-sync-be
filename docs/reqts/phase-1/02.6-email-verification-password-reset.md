# Email Verification & Password Reset Specification

## Overview
This specification defines the email verification and password reset functionality for the HeyHo Sync API. These features are critical for account security and user authentication.

## Email Verification

### Flow Overview
1. User signs up → Verification email sent automatically
2. User clicks verification link → Account verified
3. Optional: User can request resend of verification email

### 1. Sign Up with Email Verification
When a user signs up, they receive a verification email.

**Modified Signup Response:**
```json
{
  "success": true,
  "message": "User created successfully. Please check your email to verify your account.",
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "first_name": "John",
      "last_name": "Doe",
      "email_verified": false,
      "created_at": "2024-01-01T00:00:00.000Z",
      "updated_at": "2024-01-01T00:00:00.000Z"
    },
    "access_token": "<jwt_token>",
    "refresh_token": "<refresh_token>"
  }
}
```

### 2. Verify Email
Verify user's email address using the token from the email link.

**Endpoint:** `POST /api/v1/users/verify_email`

**Request Body:**
```json
{
  "token": "verification_token_from_email"
}
```

**Success Response (200 OK):**
```json
{
  "success": true,
  "message": "Email verified successfully",
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "first_name": "John",
      "last_name": "Doe",
      "email_verified": true,
      "created_at": "2024-01-01T00:00:00.000Z",
      "updated_at": "2024-01-01T00:00:00.000Z"
    }
  }
}
```

**Error Response (422 Unprocessable Entity):**
```json
{
  "success": false,
  "message": "Invalid or expired verification token",
  "errors": ["The verification link is invalid or has expired. Please request a new one."]
}
```

### 3. Resend Verification Email
Request a new verification email.

**Endpoint:** `POST /api/v1/users/resend_verification`

**Headers:**
- `Authorization: Bearer <access_token>` (required)

**Success Response (200 OK):**
```json
{
  "success": true,
  "message": "Verification email sent successfully"
}
```

**Error Response (422 Unprocessable Entity):**
```json
{
  "success": false,
  "message": "Email already verified"
}
```

**Rate Limiting Response (429 Too Many Requests):**
```json
{
  "success": false,
  "message": "Please wait 5 minutes before requesting another verification email"
}
```

## Password Reset

### Flow Overview
1. User requests password reset → Reset email sent
2. User clicks reset link → Redirected to reset form
3. User submits new password → Password updated

### 1. Request Password Reset
Send password reset instructions to user's email.

**Endpoint:** `POST /api/v1/users/password_reset`

**Request Body:**
```json
{
  "email": "user@example.com"
}
```

**Success Response (200 OK):**
```json
{
  "success": true,
  "message": "If an account exists with this email, password reset instructions have been sent"
}
```

**Note:** Always return success to prevent email enumeration attacks.

### 2. Verify Reset Token
Verify if a password reset token is valid.

**Endpoint:** `GET /api/v1/users/password_reset/verify`

**Query Parameters:**
- `token`: Reset token from email

**Success Response (200 OK):**
```json
{
  "success": true,
  "message": "Token is valid",
  "data": {
    "email": "user@example.com",
    "token_expires_at": "2024-01-01T01:00:00.000Z"
  }
}
```

**Error Response (422 Unprocessable Entity):**
```json
{
  "success": false,
  "message": "Invalid or expired reset token"
}
```

### 3. Reset Password
Update password using reset token.

**Endpoint:** `POST /api/v1/users/password_reset/confirm`

**Request Body:**
```json
{
  "token": "reset_token_from_email",
  "password": "NewPassword123!"
}
```

**Success Response (200 OK):**
```json
{
  "success": true,
  "message": "Password reset successfully",
  "data": {
    "access_token": "<new_jwt_token>",
    "refresh_token": "<new_refresh_token>"
  }
}
```

**Error Response (422 Unprocessable Entity):**
```json
{
  "success": false,
  "message": "Password reset failed",
  "errors": [
    "Token is invalid or has expired",
    "Password must be at least 8 characters"
  ]
}
```

## Email Change Verification

### Flow Overview
1. User requests email change → Verification sent to NEW email
2. User clicks verification link → Email updated
3. Notification sent to OLD email about the change

### 1. Request Email Change
Initiate email change process.

**Endpoint:** `POST /api/v1/users/me/email_change`

**Headers:**
- `Authorization: Bearer <access_token>` (required)
- `Content-Type: application/json`

**Request Body:**
```json
{
  "new_email": "newemail@example.com",
  "current_password": "CurrentPassword123!"
}
```

**Validation Rules:**
- `new_email`: Must be valid email format and not already in use
- `current_password`: Required for security, must match user's current password

**Success Response (200 OK):**
```json
{
  "success": true,
  "message": "Verification email sent to newemail@example.com. Please check your inbox."
}
```

**Error Response (422 Unprocessable Entity):**
```json
{
  "success": false,
  "message": "Email change request failed",
  "errors": [
    "Email has already been taken",
    "Current password is incorrect"
  ]
}
```

### 2. Confirm Email Change
Confirm the email change using token from verification email.

**Endpoint:** `POST /api/v1/users/me/email_change/confirm`

**Request Body:**
```json
{
  "token": "email_change_token_from_email"
}
```

**Success Response (200 OK):**
```json
{
  "success": true,
  "message": "Email changed successfully",
  "data": {
    "user": {
      "id": 1,
      "email": "newemail@example.com",
      "first_name": "John",
      "last_name": "Doe",
      "email_verified": true,
      "created_at": "2024-01-01T00:00:00.000Z",
      "updated_at": "2024-01-02T00:00:00.000Z"
    }
  }
}
```

**Error Response (422 Unprocessable Entity):**
```json
{
  "success": false,
  "message": "Email change failed",
  "errors": [
    "Token is invalid or has expired",
    "Email has already been taken"
  ]
}
```

### 3. Cancel Email Change
Cancel pending email change request.

**Endpoint:** `DELETE /api/v1/users/me/email_change`

**Headers:**
- `Authorization: Bearer <access_token>` (required)

**Success Response (200 OK):**
```json
{
  "success": true,
  "message": "Email change request cancelled"
}
```

## Email Templates

### Verification Email
**Subject:** "Verify your HeyHo Sync account"

**Body:**
```html
<!DOCTYPE html>
<html>
<head>
  <style>
    .button {
      background-color: #4CAF50;
      color: white;
      padding: 14px 20px;
      text-decoration: none;
      border-radius: 4px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h2>Welcome to HeyHo Sync!</h2>
  <p>Hi {{first_name}},</p>
  <p>Please verify your email address to complete your registration.</p>
  <p>
    <a href="{{verification_url}}" class="button">Verify Email</a>
  </p>
  <p>Or copy and paste this link in your browser:</p>
  <p>{{verification_url}}</p>
  <p>This link will expire in 24 hours.</p>
  <p>If you didn't create an account, please ignore this email.</p>
</body>
</html>
```

### Password Reset Email
**Subject:** "Reset your HeyHo Sync password"

**Body:**
```html
<!DOCTYPE html>
<html>
<head>
  <style>
    .button {
      background-color: #008CBA;
      color: white;
      padding: 14px 20px;
      text-decoration: none;
      border-radius: 4px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h2>Password Reset Request</h2>
  <p>Hi {{first_name}},</p>
  <p>We received a request to reset your password.</p>
  <p>
    <a href="{{reset_url}}" class="button">Reset Password</a>
  </p>
  <p>Or copy and paste this link in your browser:</p>
  <p>{{reset_url}}</p>
  <p>This link will expire in 1 hour.</p>
  <p>If you didn't request this, please ignore this email. Your password won't be changed.</p>
</body>
</html>
```

### Email Change Verification Email (to NEW email)
**Subject:** "Verify your new email for HeyHo Sync"

**Body:**
```html
<!DOCTYPE html>
<html>
<head>
  <style>
    .button {
      background-color: #FF9800;
      color: white;
      padding: 14px 20px;
      text-decoration: none;
      border-radius: 4px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h2>Confirm Your Email Change</h2>
  <p>Hi {{first_name}},</p>
  <p>You requested to change your HeyHo Sync email from {{old_email}} to this email address.</p>
  <p>Please confirm this change by clicking the button below:</p>
  <p>
    <a href="{{email_change_url}}" class="button">Confirm Email Change</a>
  </p>
  <p>Or copy and paste this link in your browser:</p>
  <p>{{email_change_url}}</p>
  <p>This link will expire in 24 hours.</p>
  <p>If you didn't request this change, please ignore this email.</p>
</body>
</html>
```

### Email Change Notification (to OLD email)
**Subject:** "Email change requested for your HeyHo Sync account"

**Body:**
```html
<!DOCTYPE html>
<html>
<head>
  <style>
    .alert {
      background-color: #f44336;
      color: white;
      padding: 14px 20px;
      border-radius: 4px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h2>Email Change Request</h2>
  <p>Hi {{first_name}},</p>
  <div class="alert">
    <strong>Important:</strong> A request was made to change your email address to {{new_email}}.
  </div>
  <p>If you made this request, you can safely ignore this email. The change will be completed once you verify the new email address.</p>
  <p>If you did NOT make this request, your account may be compromised. Please:</p>
  <ul>
    <li>Log in to your account immediately</li>
    <li>Change your password</li>
    <li>Contact support if you need assistance</li>
  </ul>
  <p>The email change request will expire in 24 hours if not confirmed.</p>
</body>
</html>
```

## Database Schema Updates

### Users Table
Add columns:
- `email_verified` (boolean, default: false)
- `email_verified_at` (datetime, nullable)
- `verification_token` (string, nullable, indexed)
- `verification_token_expires_at` (datetime, nullable)
- `reset_password_token` (string, nullable, indexed)
- `reset_password_token_expires_at` (datetime, nullable)
- `pending_email` (string, nullable) - stores new email during change process
- `email_change_token` (string, nullable, indexed)
- `email_change_token_expires_at` (datetime, nullable)

### Tokens Table (Alternative Approach)
Create separate table for tokens:
```sql
CREATE TABLE verification_tokens (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id),
  token VARCHAR(255) NOT NULL UNIQUE,
  token_type VARCHAR(50) NOT NULL, -- 'email_verification', 'password_reset', or 'email_change'
  expires_at TIMESTAMP NOT NULL,
  used_at TIMESTAMP,
  metadata JSONB, -- stores additional data like pending_email for email_change
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL
);

CREATE INDEX idx_verification_tokens_token ON verification_tokens(token);
CREATE INDEX idx_verification_tokens_user_id ON verification_tokens(user_id);
```

## Implementation Notes

### Security Requirements
1. **Token Generation**: Use SecureRandom.urlsafe_base64(32) for tokens
2. **Token Expiry**:
   - Email verification: 24 hours
   - Password reset: 1 hour
   - Email change: 24 hours
3. **Rate Limiting**:
   - Resend verification: Max 1 per 5 minutes
   - Password reset request: Max 3 per hour per email
   - Email change request: Max 1 per hour per user
4. **Token Usage**: Tokens should be single-use and invalidated after use
5. **Constant Response Time**: Password reset request should always return same response regardless of email existence
6. **Email Change Security**:
   - Require current password for email change requests
   - Send notification to old email immediately when change is requested
   - Send confirmation to new email for verification

### Email Service Configuration
1. **Development**: Use Letter Opener gem or MailCatcher
2. **Production**: Configure with SendGrid, AWS SES, or similar
3. **Queue**: Use ActiveJob with Sidekiq for async email sending

### Configuration Variables
```ruby
# config/application.rb or environment files
config.email_verification_enabled = true
config.email_verification_required = false # if true, restrict access until verified
config.email_verification_token_expiry = 24.hours
config.password_reset_token_expiry = 1.hour
config.mailer_sender = 'noreply@heyho.com'
config.frontend_url = ENV['FRONTEND_URL'] || 'http://localhost:3001'
```

### URL Generation
```ruby
# Email verification URL
"#{frontend_url}/verify-email?token=#{token}"

# Password reset URL
"#{frontend_url}/reset-password?token=#{token}"

# Email change URL
"#{frontend_url}/confirm-email-change?token=#{token}"
```

## Testing Considerations

1. **Email Verification Tests**:
   - Test token generation on signup
   - Test valid token verification
   - Test expired token handling
   - Test already verified email
   - Test resend rate limiting

2. **Password Reset Tests**:
   - Test reset request for existing email
   - Test reset request for non-existing email (same response)
   - Test valid token password reset
   - Test expired token handling
   - Test password validation rules
   - Test rate limiting

3. **Email Change Tests**:
   - Test email change request with correct password
   - Test email change request with incorrect password
   - Test email uniqueness validation
   - Test token verification for email change
   - Test notification sent to old email
   - Test confirmation sent to new email
   - Test cancellation of pending email change
   - Test rate limiting for email change requests

4. **Email Delivery Tests**:
   - Test email content and formatting
   - Test email queuing with ActiveJob
   - Test failure handling and retries

## User Experience Considerations

1. **Graceful Degradation**: Allow users to use basic features even if email not verified (configurable)
2. **Clear Messaging**: Inform users about verification status and any restrictions
3. **Token Expiry Notice**: Show remaining time for token validity
4. **Resend Option**: Always provide option to resend verification/reset emails
5. **Security vs UX**: Balance security (no email enumeration) with user feedback

## Future Enhancements

1. **Two-Factor Authentication**: Add SMS/TOTP support
2. **Magic Links**: Passwordless authentication option
3. **Social OAuth**: Login with Google, GitHub, etc.
4. **Security Notifications**: Email alerts for password changes, new device logins
5. **Account Recovery**: Alternative recovery methods (security questions, backup codes)
6. **Device Management**: Track and manage logged-in devices/sessions
7. **IP-based Security**: Detect and alert on suspicious login locations