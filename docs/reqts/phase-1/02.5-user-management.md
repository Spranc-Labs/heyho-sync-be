# User Management API Specification

## Overview
This specification defines the endpoints for fetching and updating user information in the HeyHo Sync API.

## Authentication
All endpoints require a valid JWT access token in the Authorization header:
```
Authorization: Bearer <access_token>
```

## Endpoints

### 1. Get Current User
Retrieve the currently authenticated user's information.

**Endpoint:** `GET /api/v1/users/me`

**Headers:**
- `Authorization: Bearer <access_token>` (required)

**Response:**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "first_name": "John",
      "last_name": "Doe",
      "created_at": "2024-01-01T00:00:00.000Z",
      "updated_at": "2024-01-01T00:00:00.000Z"
    }
  }
}
```

**Error Response (401 Unauthorized):**
```json
{
  "success": false,
  "message": "You need to sign in or sign up before continuing."
}
```

### 2. Update Current User
Update the currently authenticated user's information.

**Endpoint:** `PATCH /api/v1/users/me`

**Headers:**
- `Authorization: Bearer <access_token>` (required)
- `Content-Type: application/json`

**Request Body:**
```json
{
  "user": {
    "first_name": "Jane",
    "last_name": "Smith",
    "email": "newemail@example.com"
  }
}
```

**Validation Rules:**
- `email`: Must be unique and valid email format
- `first_name`: Required, cannot be blank
- `last_name`: Required, cannot be blank
- Password updates should be handled separately (see section 3)

**Success Response (200 OK):**
```json
{
  "success": true,
  "message": "User updated successfully",
  "data": {
    "user": {
      "id": 1,
      "email": "newemail@example.com",
      "first_name": "Jane",
      "last_name": "Smith",
      "created_at": "2024-01-01T00:00:00.000Z",
      "updated_at": "2024-01-02T00:00:00.000Z"
    }
  }
}
```

**Error Response (422 Unprocessable Entity):**
```json
{
  "success": false,
  "message": "User could not be updated",
  "errors": [
    "Email has already been taken",
    "First name can't be blank"
  ]
}
```

### 3. Update Password
Update the currently authenticated user's password.

**Endpoint:** `PATCH /api/v1/users/me/password`

**Headers:**
- `Authorization: Bearer <access_token>` (required)
- `Content-Type: application/json`

**Request Body:**
```json
{
  "user": {
    "current_password": "OldPassword123!",
    "password": "NewPassword456!"
  }
}
```

**Validation Rules:**
- `current_password`: Required, must match the user's current password
- `password`: Required, minimum 8 characters, must include uppercase, lowercase, number, and special character

**Success Response (200 OK):**
```json
{
  "success": true,
  "message": "Password updated successfully",
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "first_name": "John",
      "last_name": "Doe",
      "created_at": "2024-01-01T00:00:00.000Z",
      "updated_at": "2024-01-02T00:00:00.000Z"
    }
  }
}
```

**Error Response (422 Unprocessable Entity):**
```json
{
  "success": false,
  "message": "Password could not be updated",
  "errors": [
    "Current password is incorrect",
    "Password must be at least 8 characters"
  ]
}
```

### 4. Get User by ID (Admin Only - Future Enhancement)
Retrieve a specific user's information by their ID.

**Endpoint:** `GET /api/v1/users/:id`

**Headers:**
- `Authorization: Bearer <access_token>` (required)

**Parameters:**
- `id`: User ID (integer)

**Note:** This endpoint should be restricted to admin users only. Implementation pending role-based access control.

## Implementation Notes

1. **Controller:** Create `app/controllers/api/v1/users_controller.rb`
2. **Routes:** Add user routes to `config/routes.rb` under the API v1 namespace
3. **Strong Parameters:** Ensure proper parameter sanitization for user updates
4. **Serialization:** Use existing `UserSerializer` for consistent response format
5. **Authentication:** All endpoints must verify JWT token and set `current_user`
6. **Error Handling:** Maintain consistent error response format across all endpoints

## Testing Considerations

1. Test authentication requirements for all endpoints
2. Test validation rules for email uniqueness and field requirements
3. Test password update with correct and incorrect current password
4. Test that users cannot update other users' information
5. Test proper error messages and HTTP status codes

## Security Considerations

1. Never return password or password_digest in any response
2. Require current password for password updates
3. Ensure users can only access/modify their own data (except admins)
4. Rate limit update endpoints to prevent abuse
5. Log sensitive operations (password changes, email changes)

## Future Enhancements

1. Add role-based access control for admin endpoints
2. Add email verification for email changes
3. Add password reset via email functionality
4. Add user profile picture upload
5. Add user preferences/settings endpoint
6. Add user activity/audit log endpoint